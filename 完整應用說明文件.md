# MediPrisma · SMART on FHIR 應用說明文件

---

## 目錄

1. [系統概述](#1-系統概述)
2. [核心功能](#2-核心功能)
3. [技術架構](#3-技術架構)
4. [使用指南](#4-使用指南)
5. [臨床應用價值](#5-臨床應用價值)
6. [安全性](#6-安全性)

---

## 1. 系統概述

### 1.1 簡介

MediPrisma 是智能臨床文件助理系統，整合 SMART on FHIR 和 AI 技術，採用 Clean Architecture 和可插拔設計。

**核心能力**：
- 即時查看完整臨床資料
- AI Agent 自動查詢 FHIR 資料和醫學文獻
- AI 對話生成臨床筆記
- 對話歷史和提示範本管理

### 1.2 標準合規

- **SMART on FHIR**：符合 HL7 SMART App Launch Framework
- **OAuth 2.0 + PKCE**：安全授權機制
- **FHIR R4**：支援 FHIR Release 4

### 1.3 線上展示

- **Demo**：https://voho0000.github.io/medical-note-smart-on-fhir
- **Launch URL**：https://voho0000.github.io/medical-note-smart-on-fhir/smart/launch
- **GitHub**：https://github.com/voho0000/medical-note-smart-on-fhir
- **Firebase Functions**：https://github.com/voho0000/firebase-smart-on-fhir

---

## 2. 核心功能

### 2.1 臨床資料整合

**SMART on FHIR 認證**：
- OAuth 2.0 + PKCE 安全授權
- 與 EHR 系統無縫整合
- 自動取得病患資料存取權限

**完整臨床資料**：

| 資料類型 | 內容 |
|---------|------|
| 病患資料 | 基本資料、生命徵象 |
| 診斷 | 目前和過往診斷 |
| 用藥 | 使用中和歷史用藥、過敏史 |
| 報告 | 檢驗、影像、處置報告 |
| 就診 | 門診、住院、急診記錄 |

### 2.2 AI 功能

#### 筆記對話
- **一般模式**：快速 AI 對話
- **深入模式（AI Agent）**：
  - 7 個 FHIR 工具（診斷、用藥、檢驗等）
  - 1 個文獻搜尋工具（Perplexity）
  - 自動調用工具查詢資料

#### 臨床洞察
- 自動生成臨床摘要
- 可自訂洞察標籤
- 支援多種摘要類型

#### 提示範本庫
- 瀏覽社群共享範本
- 依類型、專科、標籤篩選
- 分享和使用計數

#### 對話歷史
- 依病人分類儲存
- Firestore 雲端同步
- 跨裝置存取

#### 語音輸入
- 麥克風錄音
- Whisper 自動轉錄
- 即時編輯

### 2.3 使用者體驗

- **多語言**：中英文介面
- **認證**：Firebase Authentication（Google、Email/密碼）
- **響應式**：支援手機、平板、桌面
- **深色模式**：護眼設計
- **可調整面板**：自訂佈局

---

## 3. 技術架構

### 3.1 技術堆疊

**前端**：
- Next.js 16（App Router + Turbopack）
- React 19
- TypeScript 5
- Tailwind CSS 4
- shadcn/ui

**AI 整合**：
- Vercel AI SDK
- OpenAI（GPT-4o, GPT-4o-mini, o1）
- Google Gemini（2.0 Flash, Pro, Thinking）
- Perplexity（sonar, sonar-pro）

**後端**：
- Firebase Authentication
- Firebase Firestore
- Firebase Functions（API 代理）

**FHIR**：
- fhirclient 2.6.3
- FHIR R4 支援

### 3.2 Clean Architecture

```
展示層 (Presentation)
  ↓
應用層 (Application)
  ↓
領域層 (Domain)
  ↓
基礎設施層 (Infrastructure)
```

**優勢**：
- 關注點分離
- 易於測試
- 可維護性高
- 業務邏輯獨立

### 3.3 可插拔架構

**左側面板**：
- 配置：`src/shared/config/feature-registry.ts`
- 4 個 Tabs、7 個功能模組

**右側面板**：
- 配置：`src/shared/config/right-panel-registry.ts`
- 4 個功能：筆記對話、資料選擇、臨床洞察、設定

**優勢**：
- 輕鬆新增/移除功能
- 低耦合、高內聚
- 易於擴展

### 3.4 AI Agent 架構

**客戶端 Tool Calling**：
- 在瀏覽器執行 tool calling
- 安全存取 FHIR 資料
- 無需後端處理敏感資料

**可用工具**：
- 7 個 FHIR 工具
- 1 個文獻搜尋工具

---

## 4. 使用指南

### 4.1 介面佈局

**左側面板**：臨床摘要
- 病患、報告、用藥、就診 4 個標籤
- 可調整大小
- 手機版自動隱藏

**右側面板**：AI 功能
- 筆記對話、資料選擇、臨床洞察、設定 4 個標籤
- 固定寬度
- 標籤式切換

**頂部工具列**：
- 連線狀態
- 語言切換
- 深色模式
- 登入/登出

### 4.2 工作流程

#### 快速查詢
1. 啟動應用程式
2. 查看左側臨床資料
3. 使用 AI 對話提問

#### 深入分析
1. 切換到深入模式
2. 提出複雜臨床問題
3. AI 自動查詢多種資料
4. 獲得整合分析結果

#### 文件記錄
1. 使用語音或文字輸入
2. AI 協助生成筆記
3. 編輯和完善內容
4. 儲存對話歷史

---

## 5. 臨床應用價值

### 5.1 提升效率

**快速資料存取**：
- 一次查看完整臨床資料
- 無需切換多個系統
- 減少資料查找時間

**AI 輔助決策**：
- 自動整合多種資料
- 提供實證醫學資訊
- 減少人工查詢時間

### 5.2 改善品質

**完整資訊**：
- 避免遺漏重要資訊
- 全面了解病患狀況
- 降低醫療錯誤風險

**標準化**：
- 一致的資料格式
- 結構化的臨床筆記
- 提升文件品質

### 5.3 增強協作

**資訊共享**：
- 提示範本庫共享經驗
- 標準化臨床流程
- 促進團隊協作

**持續照護**：
- 對話歷史記錄
- 延續照護情境
- 跨時間追蹤

---

## 6. 安全性

### 6.1 已實作

**資料加密**：
- API keys 使用 AES-GCM 256-bit 加密
- Session-based 加密密碼
- 關閉瀏覽器自動清除

**安全 Headers**：
- X-Frame-Options
- X-Content-Type-Options
- X-XSS-Protection
- Referrer-Policy
- Permissions-Policy

**認證授權**：
- SMART on FHIR OAuth 2.0 + PKCE
- Firebase Authentication
- Firestore Security Rules

**資料保護**：
- HTML Sanitization
- 錯誤訊息過濾
- 客戶端 Tool Calling（避免 Token 外洩）

### 6.2 隱私保護

**資料隔離**：
- 依病人分類儲存
- 使用者只能存取自己的資料
- Firestore Security Rules 強制執行

**本地儲存**：
- API keys 僅存於瀏覽器
- 不傳送到其他伺服器
- 使用者完全控制

### 6.3 合規性

**HIPAA**：
- 傳輸加密（HTTPS）
- 存取控制
- 審計日誌

**GDPR**：
- 使用者同意機制
- 資料可攜權
- 刪除權

---

## 附錄

### 相關文件

- [README.md](./README.md) - 專案說明
- [USER_GUIDE.md](./USER_GUIDE.md) - 使用者指南
- [ARCHITECTURE.md](./docs/ARCHITECTURE.md) - 系統架構
- [MEDICAL_CHAT.md](./docs/MEDICAL_CHAT.md) - Medical Chat 功能
- [SECURITY.md](./docs/SECURITY.md) - 安全性指南

### 系統需求

**瀏覽器**：
- Chrome 90+
- Safari 14+
- Edge 90+
- Firefox 88+

**網路**：
- 穩定的網路連線
- HTTPS 支援

**選用**：
- 麥克風（語音輸入）
- Firebase 專案（認證和對話歷史）
- API 金鑰（進階 AI 模型）

### 支援

如有問題，請透過 GitHub Issues 回報。
