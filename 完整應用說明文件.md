# MediPrisma · SMART on FHIR 完整應用說明文件

---

## 目錄

1. [系統概述](#1-系統概述)
2. [線上展示](#2-線上展示)
3. [核心功能](#3-核心功能)
4. [技術架構](#4-技術架構)
5. [系統操作說明](#5-系統操作說明)
6. [臨床應用價值](#6-臨床應用價值)
7. [安全性與隱私](#7-安全性與隱私)
8. [系統需求與部署](#8-系統需求與部署)

---

## 1. 系統概述

### 1.1 應用程式簡介

**MediPrisma · SMART on FHIR** 是一個智能臨床文件助理系統，基於國際醫療資訊標準 FHIR（Fast Healthcare Interoperability Resources）和 SMART on FHIR 授權框架開發。本系統整合人工智慧技術，協助醫療人員：

- 快速查看病患的完整臨床資料
- 使用 AI 生成臨床摘要和病歷記錄
- 透過語音輸入建立病歷
- 與 AI 助理互動，獲得臨床建議

### 1.2 開發背景

本應用程式由臺北榮民總醫院開發團隊建構，結合臨床實務經驗與現代資訊技術，旨在提升醫療人員的工作效率與決策品質。

### 1.3 標準合規性

- **SMART on FHIR**：符合 HL7 SMART App Launch Framework 規範
- **OAuth 2.0 + PKCE**：採用業界標準的安全授權機制
- **FHIR R4**：支援 FHIR Release 4 資源格式

---

## 2. 線上展示

### Demo 環境

**Demo 網站：** https://voho0000.github.io/medical-note-smart-on-fhir

**Launch URL（用於 SMART Launcher）：** https://voho0000.github.io/medical-note-smart-on-fhir/smart/launch

### 啟動方式

1. 前往 [SMART Health IT Launcher](https://launch.smarthealthit.org/)
2. 在 **App Launch URL** 欄位輸入上述 Launch URL
3. 選擇測試病患和情境
4. 點擊 **Launch** 啟動應用程式

---

## 3. 核心功能

### 3.1 臨床資料整合

#### SMART on FHIR 身份驗證
- 採用 OAuth 2.0 + PKCE 安全授權機制
- 支援與醫院 EHR 系統無縫整合
- 自動取得病患資料存取權限

#### 完整臨床資料顯示
系統從 FHIR 伺服器即時擷取並顯示以下資料：

| 資料類型 | 說明 |
|---------|------|
| 病患基本資料 | 姓名、性別、出生日期、年齡 |
| 生命徵象 | 血壓、心率、體溫、呼吸速率、血氧飽和度、身高、體重、BMI |
| 診斷/病況 | 目前和過往的診斷記錄 |
| 用藥記錄 | 使用中和歷史用藥 |
| 過敏史 | 藥物過敏和不耐症 |
| 診斷報告 | 檢驗、影像、處置報告 |
| 就診紀錄 | 門診、住院、急診、居家照護、遠距就醫記錄 |

### 3.2 AI 驅動的文件功能

#### 筆記對話（Note Chat）
互動式 AI 助理，支援：
- **語音輸入**：使用 Whisper 語音轉文字技術，實現免手持文件記錄
- **文字輸入**：直接輸入臨床問題或病歷內容
- **情境感知**：AI 可參考選定的病患資料生成回應
- **提示範本**：可重複使用的提示範本，加快筆記撰寫速度

#### 臨床洞察（Clinical Insights）
自動生成臨床分析，預設包含三個分析項目：

1. **安全警示（Safety Flag）**
   - 突顯緊急安全問題或禁忌症
   - 標記藥物交互作用、異常結果或緊急追蹤需求
   - 依嚴重程度排序

2. **變化摘要（What's Changed）**
   - 總結與先前資料相比的顯著變化
   - 列出狀態、治療或結果中最重要的變化

3. **臨床快照（Clinical Snapshot）**
   - 提供當前臨床狀況的簡明概述
   - 涵蓋活動中的問題、目前治療、近期結果和待辦事項

#### 資料選擇（Data Selection）
精確控制 AI 使用的臨床資料：
- 選擇特定資料類型（診斷、用藥、檢驗等）
- 篩選日期範圍
- 關鍵字搜尋
- 勾選特定項目作為 AI 上下文

### 3.3 個人化設定

#### AI 偏好設定
- **模型選擇**：支援多種 AI 模型
  - 內建模型（無需個人金鑰）：GPT-5 Mini、GPT-5.1、Gemini 2.5 Flash、Gemini 3 Flash Preview
  - 進階模型（需個人金鑰）：GPT-5.2、GPT-5 Pro、Gemini 2.5 Pro、Gemini 3 Pro Preview
- **外觀設定**：亮色/深色模式切換

#### 提示範本管理
- 建立可重複使用的提示範本
- 每個範本包含：標籤、描述、提示內容
- 支援新增、編輯、刪除、重設

#### 臨床洞察標籤自訂
- 啟用/停用自動生成功能
- 自訂洞察標籤的名稱、副標題、提示內容
- 支援新增、編輯、刪除、重新排序

### 3.4 多語言支援

- 支援英文和繁體中文介面
- 無縫語言切換
- 所有功能標籤和說明皆有雙語版本

---

## 4. 技術架構

### 4.1 技術堆疊

| 類別 | 技術 |
|------|------|
| 框架 | Next.js 16（App Router） |
| UI 元件 | shadcn/ui（Radix UI） |
| 樣式 | Tailwind CSS 4 |
| FHIR 客戶端 | fhirclient 2.6.3 |
| AI 整合 | OpenAI API、Google Gemini API |
| 狀態管理 | React Context API |
| 測試 | Jest + React Testing Library |
| 語言 | TypeScript（完整型別安全） |

### 4.2 系統架構

本應用程式遵循**整潔架構（Clean Architecture）**原則：

```
┌─────────────────────────────────────────────────────────────┐
│                      展示層 (Presentation)                    │
│              app/ • features/ • components/                  │
│                    UI 元件和頁面                              │
├─────────────────────────────────────────────────────────────┤
│                      應用層 (Application)                     │
│                     src/application/                         │
│           應用程式特定邏輯、hooks 和 providers                  │
├─────────────────────────────────────────────────────────────┤
│                      領域層 (Domain)                          │
│                        src/core/                             │
│                    業務實體和用例                              │
├─────────────────────────────────────────────────────────────┤
│                    基礎設施層 (Infrastructure)                 │
│                    src/infrastructure/                       │
│              外部服務整合（FHIR、AI）                          │
└─────────────────────────────────────────────────────────────┘
```

### 4.3 關鍵設計模式

- **Provider 模式**：基於 Context 的狀態管理
- **Repository 模式**：資料存取抽象
- **Adapter 模式**：外部 API 整合
- **基於功能的組織**：模組化功能結構

### 4.4 專案結構

```
medical-note-smart-on-fhir/
├── app/                          # Next.js App Router
│   ├── api/                      # API 路由
│   │   ├── gemini-proxy/         # Gemini API 代理
│   │   └── llm/                  # LLM 整合
│   ├── smart/                    # SMART on FHIR 驗證
│   │   ├── launch/               # OAuth 啟動端點
│   │   └── callback/             # OAuth 回調端點
│   └── page.tsx                  # 主應用程式頁面
├── components/                   # 可重複使用的 UI 元件
│   └── ui/                       # shadcn/ui 元件
├── features/                     # 功能模組
│   ├── clinical-insights/        # AI 生成的臨床洞察
│   ├── clinical-summary/         # 病患資料顯示
│   ├── data-selection/           # 臨床資料篩選
│   ├── medical-chat/             # AI 對話介面
│   └── settings/                 # 應用程式設定
├── src/
│   ├── application/              # 應用層
│   ├── core/                     # 領域層
│   ├── infrastructure/           # 基礎設施層
│   └── shared/                   # 共用工具
└── __tests__/                    # 測試檔案
```

---

## 5. 系統操作說明

### 5.1 介面佈局

系統採用雙面板設計：

| 面板 | 功能 |
|------|------|
| **左側面板** | 臨床摘要 - 顯示病患的完整臨床資料 |
| **右側面板** | AI 功能 - 筆記對話、資料選擇、臨床洞察、設定 |

### 5.2 左側面板：臨床摘要

#### 標籤 1：病患 / 生命徵象 / 診斷
- 病患資訊卡片：姓名、性別、出生日期、年齡
- 生命徵象卡片：最新的生命徵象數據
- 診斷卡片：目前和過往的診斷記錄

#### 標籤 2：報告
- 分為「全部」、「檢驗」、「影像」、「處置」四個子標籤
- 可篩選時間範圍（24 小時至全部時間）
- 可選擇僅顯示最新版本或所有版本

#### 標籤 3：用藥
- 用藥記錄：顯示病患的所有用藥
- 過敏史：顯示已知的藥物過敏和不耐症
- 可篩選「使用中」或「全部」用藥

#### 標籤 4：就診紀錄
- 顯示歷次就診記錄
- 包含就診類型、日期、主治醫師、診斷
- 可展開查看該次就診的檢驗、用藥、處置詳情

### 5.3 右側面板：AI 功能

#### 筆記對話（Note Chat）
1. 使用語音或文字輸入
2. 點擊「臨床資料」按鈕插入選定的病患資料
3. AI 根據輸入和病患資料生成回應
4. 複製回應內容到病歷系統

#### 資料選擇（Data Selection）
1. 選擇資料類型（診斷、用藥、檢驗等）
2. 設定篩選條件（日期範圍、關鍵字）
3. 勾選要讓 AI 參考的項目

#### 臨床洞察（Clinical Insights）
1. 點擊各個標籤查看不同分析
2. 點擊「重新生成」更新內容
3. 可編輯提示詞自訂分析內容

#### 設定（Settings）
- AI 偏好設定：模型選擇、API 金鑰、外觀
- 提示範本：管理可重複使用的提示
- 臨床洞察標籤：自訂洞察分析項目

---

## 6. 臨床應用價值

### 6.1 提升工作效率

| 應用情境 | 效益 |
|---------|------|
| 門診病歷撰寫 | 語音輸入 + AI 生成，減少打字時間 |
| 晨間查房準備 | 臨床快照快速掌握病患狀況 |
| 交班報告 | 變化摘要突顯重要變化 |
| 新病患評估 | 安全警示標記潛在風險 |

### 6.2 增進病患安全

- **藥物交互作用警示**：自動檢查並標記潛在的藥物交互作用
- **異常結果提醒**：突顯需要注意的檢驗異常
- **過敏史查核**：確保用藥前確認過敏史

### 6.3 支援臨床決策

- **情境感知 AI**：根據選定的病患資料提供相關建議
- **個人化模板**：依據專科需求自訂分析項目
- **完整資料整合**：一站式查看所有臨床資訊

---

## 7. 安全性與隱私

### 7.1 授權機制

- 採用 **SMART on FHIR OAuth 2.0 + PKCE** 標準授權流程
- 不儲存使用者密碼
- 會話資料僅存於瀏覽器

### 7.2 資料處理

- **本地處理**：API 金鑰僅儲存在使用者瀏覽器本地
- **不儲存病患資料**：應用程式不在伺服器端儲存任何病患資料
- **即時擷取**：資料從 FHIR 伺服器即時取得，不做快取

### 7.3 AI 服務

- 支援使用個人 API 金鑰，資料直接傳送至 AI 服務提供商
- 內建模型透過 Firebase Functions 代理，提供基本功能

---

## 8. 系統需求與部署

### 8.1 使用者端需求

- **瀏覽器**：Chrome、Safari、Edge、Firefox（現代版本）
- **網路**：穩定的網路連線
- **硬體**：麥克風（用於語音輸入功能）

### 8.2 SMART on FHIR 配置

| 設定項目 | 值 |
|---------|-----|
| Launch URL | `https://[domain]/smart/launch` |
| Redirect URL | `https://[domain]/smart/callback` |
| Client Type | Public（PKCE） |
| Scopes | `launch openid fhirUser patient/*.read online_access` |

### 8.3 部署選項

- **GitHub Pages**：靜態網站部署
- **Vercel**：Next.js 原生支援
- **Netlify**：靜態網站部署
- **Docker**：容器化部署

### 8.4 開發環境

```bash
# 安裝相依套件
npm install

# 啟動開發伺服器
npm run dev:webpack

# 建置正式環境
npm run build

# 執行測試
npm test
```

---

## 附錄：相關文件

- **使用者操作指南**：[USER_GUIDE.md](./USER_GUIDE.md)
- **開發者文件**：[README.md](./README.md)

---

**文件版本**：1.0  
**最後更新**：2025 年 12 月  
