# MediPrisma · 預判性臨床智能助理

> **從被動問答到主動守護，讓 AI 成為醫師的第二大腦**

## 🎥 產品展示

**完整功能展示影片**：https://youtu.be/FljLQJUaE-A

**線上展示**：https://voho0000.github.io/medical-note-smart-on-fhir/smart/launch

**GitHub 專案**：https://github.com/voho0000/medical-note-smart-on-fhir

---

## 📋 目錄

1. [專案背景：醫療現場的認知超載危機](#1-專案背景醫療現場的認知超載危機)
2. [MediPrisma 解決方案](#2-mediprisma-解決方案)
3. [核心功能](#3-核心功能)
4. [臨床影響力](#4-臨床影響力)
5. [技術架構](#5-技術架構)
6. [使用指南](#6-使用指南)
7. [安全性與合規](#7-安全性與合規)

---

## 1. 專案背景：醫療現場的認知超載危機

儘管 AI 充滿潛力，但現有工具存在**四大痛點**，導致「看得到的科技」無法轉化為「用得上的照護」：

### 🚨 四大臨床痛點

#### 1. 被動查詢的死角
**問題**：醫師忙碌時若未主動提問，AI 便無法攔截潛在風險。  
**影響**：關鍵警訊可能被遺漏，增加醫療風險。

#### 2. 提示工程的門檻
**問題**：臨床人員非 AI 專家，常因不知如何精準提問而無法獲得高品質回答。  
**影響**：AI 工具使用率低，潛力無法發揮。

#### 3. 幻覺導致的不信任
**問題**：生成內容缺乏文獻依據，查證耗時反而增加工作負擔。  
**影響**：醫師對 AI 失去信任，回歸傳統查詢方式。

#### 4. 照護脈絡的斷裂
**問題**：病歷僅紀錄結果，遺漏了關鍵的「臨床推論」。醫師回診時需耗時重建診療邏輯。  
**影響**：照護不連續，影響診療品質與效率。

---

## 2. MediPrisma 解決方案

MediPrisma 透過 **Agentic AI 架構**，重新定義了醫病與 AI 的協作關係：

### 🎯 四大創新突破

#### 從「被動問答」→「預判性臨床洞察 (Proactive Insights)」

**創新**：將 AI 從「等待指令」轉變為「自動守護」。

**應用情境**：
> 當醫師進入病歷頁面，系統的「臨床洞察」面板便已自動分析出病人肌酸酐 (Creatinine) 上升，建議檢視腎毒性藥物。這種在診療開始前即完成的預判，能有效補足人類注意力的死角。

**技術實現**：
- 載入病歷的瞬間，自動整合 FHIR 數據
- 基於預設或自訂的臨床規則生成關鍵洞察
- 異常指標自動標示與警示

---

#### 從「單打獨鬥」→「群體智慧 (Collective Intelligence)」

**創新**：開發「智慧模板庫 (Prompt Gallery)」，降低使用門檻。

**應用情境**：
> 系統內建多種經過驗證的臨床模板，更具備「分享機制」，醫師可將優化後的 Prompt 上傳，讓其他醫師一鍵套用，透過 AI 實現臨床經驗的快速傳承與標準化。

**技術實現**：
- 社群共享的 Prompt 範本庫
- 依類型、專科、標籤智能篩選
- 使用計數與評價機制
- 一鍵套用到 Chat 或 Clinical Insights

---

#### 從「黑箱生成」→「實證為本 (Evidence-Based RAG)」

**創新**：整合 Perplexity AI 搜尋引擎，實現強大的檢索增強生成 (RAG) 能力。

**應用情境**：
> 當醫師詢問困難案例的治療方針時，AI 不僅給出建議，更強制附上最新的 PubMed 或指引連結 (Citations)，杜絕 AI 幻覺，將 AI 轉化為實證醫學的強力助手。

**技術實現**：
- 整合 Perplexity AI 文獻搜尋工具
- 自動附上來源引用 (Citations)
- 支援最新醫學文獻與臨床指引
- 可追溯的實證醫學資訊

---

#### 從「片面資訊」→「連續記憶 (Longitudinal Memory)」

**創新**：實作與 FHIR ID 深度綁定的「以病人為中心」對話紀錄。

**應用情境**：
> 當病人三個月後回診，醫師點開該病人的歷史對話紀錄，即可完整回溯自己當時的決策對話脈絡。

**技術實現**：
- 對話歷史依病人 FHIR ID 分類儲存
- Firestore 雲端同步，跨裝置存取
- 完整保留臨床推論脈絡
- 支援時間軸檢視與搜尋

---

## 3. 核心功能

### 📊 App Demo
- **線上展示**：https://voho0000.github.io/medical-note-smart-on-fhir/smart/launch
- **GitHub**：https://github.com/voho0000/medical-note-smart-on-fhir

### 🏥 臨床資料整合

**SMART on FHIR 認證**：
- OAuth 2.0 + PKCE 安全授權
- 與 EHR 系統無縫整合
- 自動取得病患資料存取權限

**完整臨床資料**：

| 資料類型 | 內容 |
|---------|------|
| 病患資料 | 基本資料、生命徵象 |
| 診斷 | 目前和過往診斷 |
| 用藥 | 使用中和歷史用藥、過敏史 |
| 報告 | 檢驗、影像、處置報告 |
| 就診 | 門診、住院、急診記錄 |

### 🤖 AI 功能

#### 1. 筆記對話 (Medical Chat)
- **一般模式**：快速 AI 對話，適合簡單問答
- **深入模式（AI Agent）**：
  - **7 個 FHIR 工具**：自動查詢診斷、用藥、檢驗、過敏、就診、處置、影像報告
  - **1 個文獻搜尋工具**：Perplexity AI 實證醫學搜尋
  - **自動調用工具**：AI 根據問題自動選擇並調用相關工具
  - **整合分析**：跨資料源的智能整合與分析

#### 2. 臨床洞察 (Clinical Insights)
- **自動生成**：載入病歷即自動生成臨床摘要
- **可自訂標籤**：支援多種洞察類型（風險評估、用藥建議、檢驗追蹤等）
- **異常標示**：自動標示異常指標與潛在風險
- **範本套用**：從 Prompt Gallery 一鍵套用專業範本

#### 3. 智慧模板庫 (Prompt Gallery)
- **社群共享**：瀏覽其他醫師分享的優質範本
- **智能篩選**：依類型（Chat/Insight）、專科、標籤篩選
- **使用統計**：分享和使用計數，展示熱門範本
- **一鍵套用**：直接套用到 Chat Templates 或 Clinical Insights
- **分享機制**：上傳自己優化的 Prompt，貢獻群體智慧

#### 4. 對話歷史 (Chat History)
- **病人分類**：依 FHIR ID 自動分類儲存
- **雲端同步**：Firestore 雲端儲存，跨裝置存取
- **脈絡保留**：完整保留臨床推論與決策過程
- **時間軸檢視**：按時間順序回顧歷史對話

#### 5. 語音輸入 (Voice Input)
- **麥克風錄音**：支援即時語音輸入
- **Whisper 轉錄**：OpenAI Whisper 自動語音轉文字
- **即時編輯**：轉錄後可立即編輯修正

### 🎨 使用者體驗

- **多語言**：中英文介面無縫切換
- **認證系統**：Firebase Authentication（Google、Email/密碼）
- **響應式設計**：支援手機、平板、桌面
- **深色模式**：護眼設計，適合長時間使用
- **可調整面板**：自訂佈局，符合個人工作習慣

---

## 4. 臨床影響力

MediPrisma 讓醫師從「資訊消費者」進化為「知識創造者」，讓醫師專注於真正的臨床思考與病患照護。

### 🎯 1. 提升病人安全

**主動式風險預防**：
- 透過預判性臨床洞察，在診療開始前即標示潛在風險
- 異常指標自動警示（如腎功能異常、藥物交互作用）
- 將防護網從「事後檢討」推進至「事前預防」

**實證醫學支持**：
- 每個建議都附上文獻來源，確保決策有據可循
- 降低醫療錯誤風險，提升診療安全性

### ⚡ 2. 優化照護品質與效率

**零學習曲線**：
- 智慧模板庫讓臨床人員能立即上手 AI
- 一鍵套用經過驗證的臨床範本
- 把時間還給病人，而非浪費在學習工具上

**完整資訊整合**：
- 一次查看完整臨床資料，無需切換多個系統
- AI Agent 自動整合多種資料源
- 減少資料查找時間，提升診療效率

### 📚 3. 強化實證醫學落地

**即時文獻支援**：
- 透過可追溯來源的回答，協助醫師在診間即時應用最新臨床指引
- 整合 Perplexity AI，提供最新 PubMed 文獻與臨床指引
- 提升治療的標準化與科學性

**杜絕 AI 幻覺**：
- 強制附上 Citations，確保資訊可信度
- 將 AI 從「不可信的黑箱」轉化為「實證醫學的強力助手」

### 🧠 4. 減輕認知負荷

**連續記憶**：
- 透過 AI 記憶病人的完整決策脈絡
- 醫師不再需要反覆燒腦回憶
- 能以更清晰的思緒專注於當下的診斷

**照護連續性**：
- 完整保留臨床推論過程
- 回診時快速回溯診療邏輯
- 提升照護品質與一致性

### 🤝 5. 促進群體智慧

**經驗傳承**：
- 透過 Prompt Gallery 分享優化的臨床範本
- 實現臨床經驗的快速傳承與標準化
- 新進醫師能快速學習資深醫師的診療思維

**持續改進**：
- 使用計數與評價機制，篩選出最有效的範本
- 群體智慧不斷累積與優化

---

## 5. 技術架構

### 🏗️ 技術堆疊

**前端框架**：
- **Next.js 16**（App Router + Turbopack）- 現代化 React 框架
- **React 19** - 最新 React 版本
- **TypeScript 5** - 型別安全
- **Tailwind CSS 4** - 實用優先的 CSS 框架
- **shadcn/ui** - 高品質 UI 元件庫

**AI 整合**：
- **Vercel AI SDK** - 統一的 AI 整合介面
- **OpenAI 模型**：
  - GPT-5 Mini（內建支援）
  - GPT-5.1（需使用者 API Key）
  - GPT-5.2（需使用者 API Key）
- **Google Gemini 模型**：
  - Gemini 3 Flash Preview（內建支援）
  - Gemini 2.5 Pro（需使用者 API Key）
  - Gemini 3 Pro Preview（需使用者 API Key）
- **內部模型**（用於 AI 標題生成）：
  - GPT-5 Nano
  - Gemini 2.5 Flash-Lite

**後端服務**：
- **Firebase Authentication** - 使用者認證
- **Firebase Firestore** - 雲端資料庫
- **Firebase Functions** - API 代理與後端邏輯

**FHIR 整合**：
- **fhirclient 2.6.3** - SMART on FHIR 客戶端
- **FHIR R4** - 完整支援 FHIR Release 4 標準

### 🏛️ Clean Architecture

MediPrisma 採用 Clean Architecture 設計模式，確保程式碼的可維護性與可測試性：

```
┌─────────────────────────────────────┐
│   展示層 (Presentation Layer)        │  ← React Components, UI
├─────────────────────────────────────┤
│   應用層 (Application Layer)         │  ← Use Cases, Providers
├─────────────────────────────────────┤
│   領域層 (Domain Layer)              │  ← Entities, Business Logic
├─────────────────────────────────────┤
│   基礎設施層 (Infrastructure Layer)  │  ← FHIR, AI, Firebase
└─────────────────────────────────────┘
```

**架構優勢**：
- ✅ **關注點分離**：每層職責清晰，易於理解
- ✅ **易於測試**：業務邏輯獨立，可單獨測試
- ✅ **可維護性高**：修改一層不影響其他層
- ✅ **業務邏輯獨立**：不依賴框架或外部服務

### 🔌 可插拔架構

**左側面板（臨床資料）**：
- 配置檔：`src/shared/config/feature-registry.ts`
- 4 個主要 Tabs：病患、報告、用藥、就診
- 7 個功能模組：可輕鬆新增或移除

**右側面板（AI 功能）**：
- 配置檔：`src/shared/config/right-panel-registry.ts`
- 4 個核心功能：筆記對話、資料選擇、臨床洞察、設定

**架構優勢**：
- ✅ **輕鬆擴展**：新增功能只需註冊到配置檔
- ✅ **低耦合**：功能模組互不依賴
- ✅ **高內聚**：每個模組職責單一明確

### 🤖 AI Agent 架構

**客戶端 Tool Calling**：
- ✅ **在瀏覽器執行**：Tool calling 完全在客戶端執行
- ✅ **安全存取 FHIR**：直接透過 SMART on FHIR 存取資料
- ✅ **無需後端處理**：避免敏感資料傳送到後端
- ✅ **防止 Token 外洩**：API keys 僅存於瀏覽器

**可用工具（8 個）**：

| 工具類型 | 工具名稱 | 功能說明 |
|---------|---------|---------|
| FHIR | `get_conditions` | 查詢診斷資料 |
| FHIR | `get_medications` | 查詢用藥資料 |
| FHIR | `get_observations` | 查詢檢驗數據 |
| FHIR | `get_allergies` | 查詢過敏史 |
| FHIR | `get_encounters` | 查詢就診記錄 |
| FHIR | `get_procedures` | 查詢處置記錄 |
| FHIR | `get_diagnostic_reports` | 查詢影像報告 |
| 文獻 | `search_medical_literature` | Perplexity AI 文獻搜尋 |

### 🔐 安全架構

**多層安全防護**：
1. **傳輸層**：HTTPS 加密傳輸
2. **認證層**：OAuth 2.0 + PKCE + Firebase Auth
3. **資料層**：Firestore Security Rules
4. **應用層**：API Key 加密、HTML Sanitization
5. **客戶端**：Tool Calling 避免資料外洩

---

## 6. 使用指南

### 📱 介面佈局

#### 左側面板（臨床資料）
- **4 個主要標籤**：病患、報告、用藥、就診
- **可調整大小**：拖曳分隔線調整寬度
- **響應式設計**：手機版自動隱藏，點擊按鈕展開

#### 右側面板（AI 功能）
- **4 個核心功能**：筆記對話、資料選擇、臨床洞察、設定
- **固定寬度**：最佳化 AI 對話體驗
- **標籤式切換**：快速切換不同功能

#### 頂部工具列
- **連線狀態**：顯示 FHIR 連線狀態
- **語言切換**：中英文一鍵切換
- **深色模式**：護眼設計
- **使用者選單**：登入/登出、設定

### 🚀 快速開始

#### 1️⃣ 啟動應用
1. 從 EHR 系統啟動 MediPrisma（SMART on FHIR Launch）
2. 授權存取病患資料（OAuth 2.0）
3. 自動載入病患完整臨床資料

#### 2️⃣ 查看臨床資料
- **左側面板**：瀏覽病患基本資料、診斷、用藥、檢驗報告
- **自動整合**：所有資料已自動從 FHIR 整合
- **快速定位**：使用標籤快速切換不同資料類型

#### 3️⃣ 使用 AI 功能
- **筆記對話**：與 AI 對話，協助生成臨床筆記
- **臨床洞察**：自動生成的預判性臨床摘要
- **範本庫**：瀏覽和套用社群共享的優質範本

### 💡 典型工作流程

#### 情境 1：快速查詢與決策支援

**使用場景**：門診時需要快速了解病患用藥史與檢驗結果

1. **查看臨床資料**
   - 左側面板切換到「用藥」標籤
   - 快速瀏覽使用中和歷史用藥
   - 切換到「報告」標籤查看最新檢驗

2. **AI 對話提問**
   - 右側面板切換到「筆記對話」
   - 選擇「一般模式」快速問答
   - 輸入問題：「這位病人的腎功能趨勢如何？」

3. **獲得即時回答**
   - AI 立即分析並回答
   - 參考回答內容進行臨床決策

---

#### 情境 2：深入分析與實證支援

**使用場景**：複雜案例需要整合多種資料並查詢文獻

1. **切換深入模式**
   - 右側面板「筆記對話」
   - 切換到「深入模式（AI Agent）」

2. **提出複雜問題**
   - 輸入：「這位糖尿病患者最近血糖控制不佳，請分析可能原因並建議調整方案，需要文獻支持」

3. **AI 自動執行**
   - 🔍 自動查詢用藥資料（`get_medications`）
   - 🔍 自動查詢檢驗數據（`get_observations`）
   - 🔍 自動搜尋醫學文獻（`search_medical_literature`）
   - 📊 整合分析並附上 Citations

4. **獲得實證建議**
   - 完整的分析報告
   - 附上 PubMed 文獻連結
   - 可追溯的實證醫學建議

---

#### 情境 3：使用智慧模板庫

**使用場景**：想要使用經過驗證的臨床範本

1. **開啟範本庫**
   - 點擊「瀏覽範本庫」按鈕
   - 或從設定頁面進入

2. **篩選範本**
   - 選擇類型：Chat 或 Insight
   - 選擇專科：如「心臟科」
   - 搜尋關鍵字：如「心衰竭」

3. **預覽與使用**
   - 點擊範本卡片預覽完整內容
   - 點擊「使用」按鈕
   - 範本自動加入到 Chat Templates 或 Clinical Insights

4. **分享自己的範本**
   - 優化後的 Prompt 可分享到社群
   - 貢獻群體智慧，幫助其他醫師

---

#### 情境 4：回診時回顧決策脈絡

**使用場景**：病人三個月後回診，需要回顧上次診療邏輯

1. **開啟對話歷史**
   - 右側面板切換到「設定」
   - 點擊「對話歷史」

2. **查看病人歷史**
   - 系統自動依病人 FHIR ID 分類
   - 顯示該病人的所有歷史對話

3. **回溯決策過程**
   - 點擊查看三個月前的對話
   - 完整回顧當時的臨床推論
   - 了解為何做出特定決策

4. **延續照護**
   - 基於歷史脈絡繼續對話
   - 確保照護連續性

---

## 7. 安全性與合規

### 🔒 多層安全防護

MediPrisma 採用多層安全架構，確保病患資料與使用者隱私的安全：

#### 1. 傳輸層安全
- **HTTPS 加密**：所有資料傳輸使用 TLS 1.3 加密
- **安全 Headers**：
  - `X-Frame-Options`: 防止 Clickjacking 攻擊
  - `X-Content-Type-Options`: 防止 MIME 類型混淆
  - `X-XSS-Protection`: 啟用瀏覽器 XSS 防護
  - `Referrer-Policy`: 控制 Referrer 資訊洩漏
  - `Permissions-Policy`: 限制瀏覽器功能存取

#### 2. 認證與授權
- **SMART on FHIR OAuth 2.0 + PKCE**：
  - 符合 HL7 標準的安全授權機制
  - PKCE (Proof Key for Code Exchange) 防止授權碼攔截
  - 最小權限原則，僅請求必要的資料存取權限

- **Firebase Authentication**：
  - 支援 Google、Email/密碼登入
  - 多因素認證 (MFA) 支援
  - Session 管理與自動過期

#### 3. 資料保護
- **API Key 加密**：
  - 使用 AES-GCM 256-bit 加密演算法
  - Session-based 加密密鑰，關閉瀏覽器自動清除
  - 僅存於瀏覽器本地，不傳送到任何伺服器

- **客戶端 Tool Calling**：
  - Tool calling 完全在瀏覽器執行
  - 避免敏感資料傳送到後端
  - 防止 API Token 外洩風險

- **HTML Sanitization**：
  - 所有使用者輸入經過清理
  - 防止 XSS (Cross-Site Scripting) 攻擊
  - 錯誤訊息過濾，避免資訊洩漏

#### 4. 資料隔離
- **Firestore Security Rules**：
  - 使用者只能存取自己的資料
  - 依病人 FHIR ID 分類儲存
  - 強制執行存取控制規則

- **本地優先**：
  - API keys 僅存於瀏覽器
  - 使用者完全控制自己的金鑰
  - 不依賴第三方儲存

### 📋 合規性

#### HIPAA (Health Insurance Portability and Accountability Act)
- ✅ **傳輸加密**：HTTPS/TLS 加密所有資料傳輸
- ✅ **存取控制**：OAuth 2.0 + PKCE + Firebase Auth
- ✅ **審計日誌**：Firestore 自動記錄所有資料存取
- ✅ **最小權限**：僅請求必要的 FHIR 資料存取權限

#### GDPR (General Data Protection Regulation)
- ✅ **使用者同意**：明確的授權流程與同意機制
- ✅ **資料可攜權**：使用者可匯出自己的對話歷史
- ✅ **刪除權**：使用者可刪除自己的資料
- ✅ **透明度**：清楚說明資料使用方式

#### SMART on FHIR 標準
- ✅ **HL7 SMART App Launch Framework** 完整實作
- ✅ **FHIR R4** 標準支援
- ✅ **OAuth 2.0 + PKCE** 安全授權
- ✅ **Scopes 管理**：精確控制資料存取範圍

### ⚠️ 安全最佳實踐

**使用者責任**：
1. **保護 API Keys**：不要分享您的 API 金鑰
2. **定期更新**：定期更換 API 金鑰
3. **安全環境**：在安全的網路環境使用
4. **登出習慣**：使用完畢後登出系統

**系統限制**：
- MediPrisma 是臨床決策支援工具，不能取代專業醫療判斷
- AI 生成的內容僅供參考，最終決策由醫師負責
- 建議搭配實證醫學文獻驗證 AI 建議

---

## 📚 附錄

### 相關文件

- **[README.md](./README.md)** - 專案說明與快速開始
- **[USER_GUIDE.md](./USER_GUIDE.md)** - 詳細使用者指南
- **[ARCHITECTURE.md](./docs/ARCHITECTURE.md)** - 系統架構文件
- **[MEDICAL_CHAT.md](./docs/MEDICAL_CHAT.md)** - Medical Chat 功能說明
- **[AI_AGENT_IMPLEMENTATION.md](./docs/AI_AGENT_IMPLEMENTATION.md)** - AI Agent 實作細節
- **[FEATURES.md](./docs/FEATURES.md)** - 功能清單

### 🖥️ 系統需求

**支援的瀏覽器**：
- ✅ Chrome 90+（推薦）
- ✅ Safari 14+
- ✅ Edge 90+
- ✅ Firefox 88+

**網路需求**：
- 穩定的網路連線
- HTTPS 支援（必須）
- 建議頻寬：5 Mbps 以上

**選用功能需求**：
- **語音輸入**：麥克風裝置
- **對話歷史**：Firebase 帳號（免費）
- **進階 AI 模型**：OpenAI/Gemini/Perplexity API 金鑰

### 🔗 相關連結

- **線上展示**：https://voho0000.github.io/medical-note-smart-on-fhir/smart/launch
- **GitHub 前端**：https://github.com/voho0000/medical-note-smart-on-fhir
- **GitHub 後端**：https://github.com/voho0000/firebase-smart-on-fhir
- **SMART on FHIR 文件**：https://docs.smarthealthit.org/
- **FHIR R4 規範**：https://hl7.org/fhir/R4/

### 💬 支援與回饋

**問題回報**：
- GitHub Issues：https://github.com/voho0000/medical-note-smart-on-fhir/issues

**功能建議**：
- 歡迎透過 GitHub Issues 提出功能建議
- 或直接提交 Pull Request 貢獻程式碼

**社群討論**：
- 歡迎在 GitHub Discussions 分享使用經驗
- 分享優質的 Prompt 範本到 Prompt Gallery

---

## 🎓 總結

MediPrisma 不僅是一個技術產品，更是一個**臨床工作流程的革新**。透過四大創新突破：

1. **預判性臨床洞察** - 從被動問答到主動守護
2. **群體智慧** - 從單打獨鬥到經驗共享
3. **實證為本** - 從黑箱生成到可追溯的實證醫學
4. **連續記憶** - 從片面資訊到完整的照護脈絡

我們將 AI 從「資訊查詢工具」提升為「臨床決策夥伴」，讓醫師能夠：
- ✅ 更安全地照護病人
- ✅ 更有效率地工作
- ✅ 更有信心地做出決策
- ✅ 更輕鬆地傳承經驗

**MediPrisma 讓醫師從「資訊消費者」進化為「知識創造者」，讓 AI 成為醫師的第二大腦。**

---

## 📄 授權資訊

本專案採用 **Apache License 2.0** 開源授權。

### 授權特點

- ✅ **商業使用**：允許用於商業目的
- ✅ **修改**：允許修改原始碼
- ✅ **分發**：允許分發原始碼和修改版本
- ✅ **專利授權**：提供明確的專利授權
- ✅ **私人使用**：允許私人使用

### 授權條件

- 📋 **授權聲明**：必須包含原始授權和版權聲明
- 📋 **狀態變更**：修改的檔案必須註明變更
- 📋 **相同授權**：衍生作品可使用不同授權

完整授權條款請參閱 [LICENSE](./LICENSE) 檔案。

---

*最後更新：2025-01-29*  
*版本：2.0*  
*授權：Apache License 2.0*
